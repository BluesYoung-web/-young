{"version":3,"file":"index.cjs.js","sources":["../src/core/share.ts","../src/core/slave.ts","../src/core/master.ts"],"sourcesContent":["/*\r\n * @Author: zhangyang\r\n * @Date: 2022-07-02 15:08:54\r\n * @LastEditTime: 2022-07-02 19:59:17\r\n * @Description: \r\n */\r\nexport const SHAKE_HANDS_MSG = '---young-rpc-shake-hands-message-request---';","/*\r\n * @Author: zhangyang\r\n * @Date: 2022-07-02 14:57:53\r\n * @LastEditTime: 2022-07-03 09:12:37\r\n * @Description: \r\n */\r\nimport { GetParamsSign, Young } from '../../typings';\r\nimport { SHAKE_HANDS_MSG } from './share';\r\n\r\ntype SlaveHandlers<T extends string | number | symbol> = Partial<Record<T, (args: Young.MasterReturnParams) => Promise<void>>>;\r\n\r\nexport class YoungRPCSlave<R extends Record<string, any>, T extends keyof R = keyof R> {\r\n  public port: MessagePort;\r\n  private masterWindow: Window;\r\n\r\n  private handlersMap: SlaveHandlers<T> = {};\r\n\r\n  constructor() {\r\n    if (window.opener && window.opener !== window) {\r\n      // Áî±Áà∂Á™óÂè£ÈÄöËøá window.open ÊâìÂºÄÁöÑ\r\n      this.masterWindow = window.opener;\r\n    } else if (window.parent && window.parent !== window) {\r\n      // iframe ÂµåÂ•ó\r\n      this.masterWindow = window.parent;\r\n    }\r\n    // ‰∏éÁà∂È°µÈù¢Êè°ÊâãÔºåÂª∫Á´ã‰ø°ÈÅì\r\n    this.shakeHands();\r\n  }\r\n\r\n  public shakeHands() {\r\n    if (!this.masterWindow) {\r\n      throw new Error('YoungRPCSlave can only be used in sub window');\r\n    }\r\n    const channel = new MessageChannel();\r\n    this.port = channel.port1;\r\n    this.port.onmessage = (e) => {\r\n      const { data, isTrusted } = e;\r\n      if (isTrusted && data) {\r\n        if (data.cmd && typeof data.cmd === 'string' && this.handlersMap[data.cmd as T]) {\r\n          // Â∑≤Áü•ÁöÑÊ∂àÊÅØÁ±ªÂûã\r\n          this.handlersMap[data.cmd](data as Young.MasterReturnParams);\r\n        }  else {\r\n          // Êú™Áü•ÁöÑÊ∂àÊÅØÁ±ªÂûã\r\n          console.warn('üöÄunknown msg', data);\r\n        }\r\n      }\r\n    };\r\n    this.port.onmessageerror = (e) => {\r\n      console.error('üöÄ ~ YoungRPCSlave ~ e', e);\r\n    };\r\n    \r\n    this.masterWindow.postMessage(SHAKE_HANDS_MSG, '*', [channel.port2]);\r\n  }\r\n\r\n  public trigger(cmd: T, params: Record<string, any> = {}) {\r\n    this.port.postMessage({ cmd, params });\r\n  }\r\n\r\n  public setHandler(cmd: T, { success, fail }: Young.Cbk) {\r\n    this.handlersMap[cmd] = async ({ ok, data }) => {\r\n      if (ok) {\r\n        await success?.(data);\r\n      } else {\r\n        await fail?.(data);\r\n      }\r\n    };\r\n    return this.trigger.bind(this, cmd) as (params?: GetParamsSign<R[T]>) => void;\r\n  }\r\n};","/*\r\n * @Author: zhangyang\r\n * @Date: 2022-07-02 14:57:48\r\n * @LastEditTime: 2022-07-03 09:49:56\r\n * @Description: \r\n */\r\nimport { GetParamsSign, Young } from '../../typings';\r\nimport { SHAKE_HANDS_MSG } from './share';\r\n\r\ntype MasterCbk<R extends Record<string, any>, T extends keyof R = keyof R> = (params: GetParamsSign<R[T]>) => any | Promise<any>;\r\ntype MasterHandlers<R extends Record<string, any>, T extends keyof R = keyof R> = Partial<Record<T, MasterCbk<R, T>>>;\r\n\r\nexport class YoungRPCMaster<R extends Record<string, any>, T extends keyof R = keyof R> {\r\n  private port: MessagePort;\r\n  private handlersMap: MasterHandlers<R, T> = {};\r\n  constructor() {\r\n    window.addEventListener('message', async (e) => {\r\n      if (e.data === SHAKE_HANDS_MSG) {\r\n        this.port = e.ports[0];\r\n        this.port.onmessage = (e) => {\r\n          const { data, isTrusted } = e;\r\n          if (isTrusted && data) {\r\n            // ÂèØ‰ª•Ê≠£ÂºèÂ§ÑÁêÜÊ∂àÊÅØ‰∫Ü\r\n            if (data.cmd && typeof data.cmd === 'string' && this.handlersMap[data.cmd as T]) {\r\n              // Â∑≤Áü•ÁöÑÊ∂àÊÅØÁ±ªÂûã\r\n              this.handlersMap[data.cmd](data.params as GetParamsSign<R[T]>);\r\n            }  else {\r\n              // Êú™Áü•ÁöÑÊ∂àÊÅØÁ±ªÂûã\r\n              console.warn('üöÄunknown msg', data);\r\n            }\r\n          }\r\n        };\r\n        this.port.onmessageerror = (e) => {\r\n          console.error('üöÄ ~ YoungRPCMaster ~ ', e);\r\n        };\r\n        console.log('üöÄüöÄüöÄ master app is ready üöÄüöÄüöÄ');\r\n      }\r\n    });\r\n  }\r\n\r\n  public setHandler(cmd: T, cbk: MasterCbk<R, T>) {\r\n    this.handlersMap[cmd] = cbk;\r\n  }\r\n\r\n  public close() {\r\n    // ÂÖ≥Èó≠‰ø°ÈÅì\r\n    this.port.close();\r\n  }\r\n\r\n  public sendMsg(data: Young.MasterReturnParams & { cmd: T }) {\r\n    this.port.postMessage(data);\r\n  }\r\n};"],"names":[],"mappings":"4GAMO,KAAM,GAAkB,8CCKxB,MAAM,CAA0E,CAMrF,aAAc,CAFd,KAAQ,YAAgC,GAGtC,AAAI,OAAO,QAAU,OAAO,SAAW,OAErC,KAAK,aAAe,OAAO,OAClB,OAAO,QAAU,OAAO,SAAW,QAE5C,MAAK,aAAe,OAAO,QAG7B,KAAK,WAAW,CAClB,CAEA,YAAoB,CACd,GAAA,CAAC,KAAK,aACF,KAAA,IAAI,OAAM,8CAA8C,EAE1D,KAAA,GAAU,GAAI,gBACpB,KAAK,KAAO,EAAQ,MACf,KAAA,KAAK,UAAY,AAAC,GAAM,CACrB,KAAA,CAAE,OAAM,aAAc,EAC5B,AAAI,GAAa,GACX,CAAA,EAAK,KAAO,MAAO,GAAK,KAAQ,UAAY,KAAK,YAAY,EAAK,KAE/D,KAAA,YAAY,EAAK,KAAK,CAAgC,EAGnD,QAAA,KAAK,uBAAiB,CAAI,EAEtC,EAEG,KAAA,KAAK,eAAiB,AAAC,GAAM,CACxB,QAAA,MAAM,gCAA0B,CAAC,CAAA,EAG3C,KAAK,aAAa,YAAY,EAAiB,IAAK,CAAC,EAAQ,KAAK,CAAC,CACrE,CAEA,QAAe,EAAQ,EAA8B,GAAI,CACvD,KAAK,KAAK,YAAY,CAAE,MAAK,QAAQ,CAAA,CACvC,CAEA,WAAkB,EAAQ,CAAE,UAAS,QAAmB,CACtD,YAAK,YAAY,GAAO,MAAO,CAAE,KAAI,UAAW,CAC9C,AAAI,EACF,KAAM,kBAAU,IAEhB,KAAM,kBAAO,GACf,EAEK,KAAK,QAAQ,KAAK,KAAM,CAAG,CACpC,CACF,CCxDO,MAAM,CAA2E,CAGtF,aAAc,CADd,KAAQ,YAAoC,GAEnC,OAAA,iBAAiB,UAAW,KAAO,IAAM,CAC1C,AAAA,EAAE,OAAS,GACR,MAAA,KAAO,EAAE,MAAM,GACf,KAAA,KAAK,UAAY,AAAC,GAAM,CACrB,KAAA,CAAE,OAAM,aAAc,EAC5B,AAAI,GAAa,GAEX,CAAA,EAAK,KAAO,MAAO,GAAK,KAAQ,UAAY,KAAK,YAAY,EAAK,KAEpE,KAAK,YAAY,EAAK,KAAK,EAAK,MAA6B,EAGrD,QAAA,KAAK,uBAAiB,CAAI,EAEtC,EAEG,KAAA,KAAK,eAAiB,AAAC,GAAM,CACxB,QAAA,MAAM,gCAA0B,CAAC,CAAA,EAE3C,QAAQ,IAAI,6EAAmC,EACjD,CACD,CACH,CAEO,WAAW,EAAQ,EAAsB,CAC9C,KAAK,YAAY,GAAO,CAC1B,CAEA,OAAe,CAEb,KAAK,KAAK,OACZ,CAEO,QAAQ,EAA6C,CACrD,KAAA,KAAK,YAAY,CAAI,CAC5B,CACF"}