{"version":3,"file":"index.es.js","sources":["../src/casdoor-sdk.ts","../src/no-login/master.ts","../src/no-login/slave.ts","../src/index.ts"],"sourcesContent":["// Copyright 2021 The casbin Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nexport interface SdkConfig {\n  serverUrl: string, // your Casdoor server URL, e.g., \"https://door.casbin.com\" for the official demo site\n  clientId: string, // the Client ID of your Casdoor application, e.g., \"014ae4bd048734ca2dea\"\n  appName: string, // the name of your Casdoor application, e.g., \"app-casnode\"\n  organizationName: string // the name of the Casdoor organization connected with your Casdoor application, e.g., \"casbin\"\n  redirectPath?: string // the path of the redirect URL for your Casdoor application, will be \"/callback\" if not provided\n}\n\n// reference: https://github.com/casdoor/casdoor-go-sdk/blob/90fcd5646ec63d733472c5e7ce526f3447f99f1f/auth/jwt.go#L19-L32\nexport interface Account {\n  organization: string,\n  username: string,\n  type: string,\n  name: string,\n  avatar: string,\n  email: string,\n  phone: string,\n  affiliation: string,\n  tag: string,\n  language: string,\n  score: number,\n  isAdmin: boolean,\n  accessToken: string\n}\n\nclass Sdk {\n  private config: SdkConfig\n\n  constructor(config: SdkConfig) {\n      this.config = config\n      if (config.redirectPath === undefined || config.redirectPath === null) {\n          this.config.redirectPath = \"/callback\";\n      }\n  }\n\n  public getSignupUrl(enablePassword: boolean = true): string {\n      if (enablePassword) {\n          return `${this.config.serverUrl.trim()}/signup/${this.config.appName}`;\n      } else {\n          return this.getSigninUrl().replace(\"/login/oauth/authorize\", \"/signup/oauth/authorize\");\n      }\n  }\n\n  public getSigninUrl(): string {\n      const redirectUri = `${window.location.origin}${this.config.redirectPath}`;\n      const scope = \"read\";\n      const state = this.config.appName;\n      return `${this.config.serverUrl.trim()}/login/oauth/authorize?client_id=${this.config.clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scope}&state=${state}`;\n  }\n\n  public getUserProfileUrl(userName: string, account: Account): string {\n      let param = \"\";\n      if (account !== undefined && account !== null) {\n          param = `?access_token=${account.accessToken}`;\n      }\n      return `${this.config.serverUrl.trim()}/users/${this.config.organizationName}/${userName}${param}`;\n  }\n\n  public getMyProfileUrl(account: Account): string {\n      let param = \"\";\n      if (account !== undefined && account !== null) {\n          param = `?access_token=${account.accessToken}`;\n      }\n      return `${this.config.serverUrl.trim()}/account${param}`;\n  }\n\n  public signin(serverUrl: string): Promise<Response> {\n      const params = new URLSearchParams(window.location.search);\n      return fetch(`${serverUrl}/api/signin?code=${params.get(\"code\")}&state=${params.get(\"state\")}`, {\n          method: \"POST\",\n          credentials: \"include\",\n      }).then(res => res.json());\n  }\n}\n\nexport default Sdk;\n","/*\n * @Author: zhangyang\n * @Date: 2022-05-25 11:42:10\n * @LastEditTime: 2022-05-25 12:23:41\n * @Description: 免登陆主应用\n */\n\nimport type { OnMessage } from '../typings/login';\n\nexport const defaultCmd = 'I want to login';\n\ntype Config = {\n  onmsg_cbk: OnMessage;\n};\n\nexport class Master {\n  constructor(conf: Config, cmd = defaultCmd) {\n    const onMessage: OnMessage = async (e) => {\n      if (e.data.cmd === cmd) {\n        conf.onmsg_cbk(e);\n      }\n    };\n\n    window.addEventListener('message', onMessage);\n  }\n};","/*\n * @Author: zhangyang\n * @Date: 2022-05-25 11:42:32\n * @LastEditTime: 2022-05-25 12:26:18\n * @Description: 免登陆子应用\n */\n\nimport type { OnMessage } from '../typings/login';\nimport { defaultCmd } from './master';\n\ntype Config = {\n  master_url: string;\n  onmsg_cbk: (args: any) => Promise<void>;\n};\n\n\nexport class Slave {\n  constructor(\n    conf: Config,\n    private cmd = defaultCmd\n  ) {\n    const onMessage: OnMessage = async (e) => {\n      if (e.origin === conf.master_url) {\n        await conf.onmsg_cbk(e.data);\n      }\n    };\n\n    window.addEventListener('message', onMessage);\n  }\n\n  init(fallback?: () => void) {\n    if (window.opener) {\n      (window.opener as Window).postMessage({\n        cmd: this.cmd\n      }, '*');\n    } else {\n      fallback?.();\n    }\n  }\n};","/*\n * @Author: zhangyang\n * @Date: 2022-05-17 17:09:04\n * @LastEditTime: 2022-05-25 12:08:50\n * @Description: \n */\nimport Casdoor from './casdoor-sdk';\nimport type { SdkConfig } from './casdoor-sdk';\n\ntype Operate = |\n'login' |\n'register';\n\nconst defaultConf: SdkConfig = {\n  serverUrl: 'https://door.casdoor.com',\n  clientId: '014ae4bd048734ca2dea',\n  organizationName: 'casbin',\n  appName: 'app-casnode',\n  redirectPath: window.location.pathname\n};\n\nexport class YoungAuth {\n  static hasAuthed() {\n    const { code, state } = Object.fromEntries(new URLSearchParams(window.location.search));\n    if (code && state) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  private sdk: Casdoor;\n  constructor(conf: Partial<SdkConfig> = {}) {\n    const finalConf = Object.assign(defaultConf, conf);\n    this.sdk = new Casdoor(finalConf);\n  }\n\n  init(operate: Operate = 'login') {\n    let url = '';\n    if (operate === 'register') {\n      url = this.sdk.getSignupUrl();\n    } else {\n      url = this.sdk.getSigninUrl();\n    }\n    window.location.href = url;\n  }\n};\n\nexport * from './no-login/master';\nexport * from './no-login/slave';"],"names":["Casdoor"],"mappings":"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"}